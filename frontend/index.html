<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>K-Pop Bias Picker (Simple)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <style>
    /* Simple, readable styles */
    body { font-family: system-ui, Arial, sans-serif; margin: 2rem; max-width: 720px; }
    h1 { margin-bottom: .25rem; }
    .card { border: 1px solid #ddd; border-radius: 12px; padding: 1rem; margin: 1rem 0; }
    .row { display: flex; gap: .75rem; align-items: center; margin: .35rem 0; }
    .votes { font-weight: 600; background: rgba(0,0,0,.06); padding: .05rem .4rem; border-radius: 999px; }
    button { padding: .6rem 1rem; border-radius: 10px; border: 1px solid #333; cursor: pointer; }
    button:disabled { opacity: .6; cursor: not-allowed; }
    .success { color: #0a7a0a; }
    .error { color: #a10a0a; }
  </style>
</head>
<body>
  <h1>Bias Picker <span style="font-size:.7em;opacity:.7">â€” NCT 127 ðŸ’š</span></h1>
  <p id="status"></p>

  <!-- VOTING CARD -->
  <div class="card" aria-labelledby="groupTitle">
    <div id="groupTitle" style="font-weight:600;"></div>
    <div id="members"></div>

    <div style="margin-top:1rem; display:flex; align-items:center; gap:.75rem;">
      <button id="voteBtn">Vote</button>
      <span id="voteMsg"></span>
    </div>
  </div>
  
  <!-- RESULTS -->
  <section id="results-section" style="margin-top: 2rem;">
    <h2>Results</h2>
    <ul id="results" style="list-style: none; padding-left: 0;"></ul>
    <div id="results-total" style="margin-top: 0.5rem; font-weight: 600;"></div>
  </section>

  <script>
    /******************************************************************
     * CONFIG â€” set these to your API Gateway base and your group id  *
     ******************************************************************/
    const API_BASE = "https://wbgdtiq28c.execute-api.us-east-1.amazonaws.com"; // your invoke URL
    const GROUP_ID = "nct127";

    const BASE = API_BASE.replace(/\/$/, ''); // normalize

    /******************************************************************
     * DOM elements                                                   *
     ******************************************************************/
    const statusEl       = document.getElementById('status');
    const titleEl        = document.getElementById('groupTitle');
    const membersEl      = document.getElementById('members');
    const voteBtn        = document.getElementById('voteBtn');
    const voteMsg        = document.getElementById('voteMsg');
    const resultsListEl  = document.getElementById('results');
    const resultsTotalEl = document.getElementById('results-total');

    /******************************************************************
     * State                                                          *
     ******************************************************************/
    let selectedMemberId = null;
    let lastMembersSnapshot = []; // [{ member, votes }]

    voteBtn.disabled = true; // until a member is selected

    /******************************************************************
     * Render members (radio list)                                    *
     ******************************************************************/
    function renderMembers(members) {
      membersEl.innerHTML = '';

      if (!Array.isArray(members) || members.length === 0) {
        membersEl.innerHTML = `<div style="opacity:.8">No members found for this group.</div>`;
        return;
      }

      members.forEach(m => {
        const row = document.createElement('div');
        row.className = 'row';

        const input = document.createElement('input');
        input.type = 'radio';
        input.name = 'member';
        input.id = `m_${m.memberId}`;
        input.value = m.memberId;
        input.addEventListener('change', () => {
          selectedMemberId = m.memberId;
          voteBtn.disabled = false;
        });

        const label = document.createElement('label');
        label.htmlFor = input.id;
        label.textContent = m.memberName;

        const votesSpan = document.createElement('span');
        votesSpan.className = 'votes';
        votesSpan.textContent = `(${Number(m.votes ?? 0)})`;

        row.appendChild(input);
        row.appendChild(label);
        row.appendChild(votesSpan);
        membersEl.appendChild(row);
      });
    }

    /******************************************************************
     * Render results list                                            *
     * expects: [{ member: "Name", votes: 3 }, ...]                  *
     ******************************************************************/
    function renderResultsList(results) {
      resultsListEl.innerHTML = '';

      if (!Array.isArray(results) || results.length === 0) {
        resultsListEl.innerHTML = `<li style="opacity:.8;">No votes yet.</li>`;
        resultsTotalEl.textContent = '';
        return;
      }

      results.forEach(row => {
        const li = document.createElement('li');
        li.className = 'row';
        li.style.justifyContent = 'space-between';
        li.innerHTML = `<span>${row.member}</span><span class="votes">${row.votes}</span>`;
        resultsListEl.appendChild(li);
      });
    }

    /******************************************************************
     * Fallback: build results from the group snapshot                *
     ******************************************************************/
    function buildResultsFromSnapshot() {
      const arr = lastMembersSnapshot.map(m => ({
        member: m.member,
        votes: Number(m.votes ?? 0)
      }));
      arr.sort((a, b) => b.votes - a.votes || a.member.localeCompare(b.member));
      const total = arr.reduce((sum, r) => sum + (Number.isFinite(r.votes) ? r.votes : 0), 0);
      return { results: arr, totalVotes: total };
    }

    /******************************************************************
     * GET /groups/{GROUP_ID}                                         *
     ******************************************************************/
    async function loadGroup() {
      statusEl.textContent = "Loading group...";
      try {
        const res  = await fetch(`${BASE}/groups/${encodeURIComponent(GROUP_ID)}`);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();

        titleEl.textContent = `${data.groupName} (${data.groupId})`;

        const members = Array.isArray(data.members) ? data.members : [];
        lastMembersSnapshot = members.map(m => ({
          member: m.memberName,
          votes: Number(m.votes ?? 0)
        }));

        renderMembers(members);
        statusEl.textContent = "";
      } catch (err) {
        console.error(err);
        statusEl.innerHTML = `<span class="error">Failed to load group. Check API_BASE/GROUP_ID & CORS.</span>`;
      }
    }

    /******************************************************************
     * GET /groups/{GROUP_ID}/results                                 *
     * Supports multiple shapes:
     *  1) { members: [{memberId, memberName, votes}, ...] }
     *  2) { results: [{member, votes}, ...] }
     *  3) { results: {memberId: votes, ...} }  (falls back to names from snapshot)
     ******************************************************************/
    async function fetchResults() {
      try {
        const res = await fetch(`${BASE}/groups/${encodeURIComponent(GROUP_ID)}/results`);
        let resultsData = null;

        if (res.ok) {
          const payload = await res.json();

          // Prefer the pretty members list if present
          if (Array.isArray(payload?.members) && payload.members.length > 0) {
            const rows = payload.members.map(m => ({
              member: String(m.memberName ?? m.memberId),
              votes: Number(m.votes ?? 0)
            }));
            rows.sort((a, b) => b.votes - a.votes || a.member.localeCompare(b.member));
            resultsData = { results: rows, totalVotes: rows.reduce((s, r) => s + r.votes, 0) };
          }
          // Or use results as an array of {member, votes}
          else if (Array.isArray(payload?.results) && payload.results.length > 0) {
            const rows = payload.results.map(r => ({
              member: String(r.member),
              votes: Number(r.votes ?? 0)
            }));
            rows.sort((a, b) => b.votes - a.votes || a.member.localeCompare(b.member));
            const total = Number(payload.totalVotes ?? rows.reduce((s, r) => s + r.votes, 0));
            resultsData = { results: rows, totalVotes: total };
          }
          // Or results as a map {id: votes}
          else if (payload && payload.results && typeof payload.results === 'object') {
            const map = payload.results;
            const rows = Object.keys(map).map(id => {
              // try to find a nice name from snapshot
              const snap = lastMembersSnapshot.find(m => m.member.toLowerCase().replace(/\s+/g,'') === id.toLowerCase());
              return {
                member: snap ? snap.member : id,
                votes: Number(map[id] ?? 0)
              };
            });
            rows.sort((a, b) => b.votes - a.votes || a.member.localeCompare(b.member));
            const total = rows.reduce((s, r) => s + r.votes, 0);
            resultsData = { results: rows, totalVotes: total };
          }
        }

        // Fallback if API returned nothing useful
        if (!resultsData) {
          resultsData = buildResultsFromSnapshot();
        }

        renderResultsList(resultsData.results);
        resultsTotalEl.textContent = `Total votes: ${resultsData.totalVotes}`;
      } catch (err) {
        console.error(err);
        const fallback = buildResultsFromSnapshot();
        renderResultsList(fallback.results);
        resultsTotalEl.textContent = `Total votes: ${fallback.totalVotes}`;
      }
    }

    /******************************************************************
     * POST /groups/{GROUP_ID}/vote                                   *
     ******************************************************************/
    async function vote() {
      voteMsg.textContent = "";

      if (!selectedMemberId) {
        voteMsg.innerHTML = `<span class="error">Please select a member first.</span>`;
        return;
      }

      const oldText = voteBtn.textContent;
      voteBtn.textContent = "Submittingâ€¦";
      voteBtn.disabled = true;

      try {
        const res  = await fetch(`${BASE}/groups/${encodeURIComponent(GROUP_ID)}/vote`, {
          method: "POST",
          headers: {"Content-Type": "application/json"},
          body: JSON.stringify({ memberId: selectedMemberId })
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.message || `HTTP ${res.status}`);

        voteMsg.innerHTML = `<span class="success">Vote recorded for ${data.memberName || 'member'}!</span>`;

        // Refresh numbers
        await loadGroup();
        await fetchResults();
      } catch (err) {
        voteMsg.innerHTML = `<span class="error">${err.message}</span>`;
      } finally {
        voteBtn.textContent = oldText;
        selectedMemberId = null;
        const checked = document.querySelector('input[name="member"]:checked');
        if (checked) checked.checked = false;
        voteBtn.disabled = true;
      }
    }

    /******************************************************************
     * Wire up + initial load                                         *
     ******************************************************************/
    document.getElementById('voteBtn').addEventListener('click', vote);
    loadGroup();
    fetchResults();
  </script>
</body>
</html>
