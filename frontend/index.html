<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>K-Pop Bias Picker (Simple)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <base href="../">
  <style>
    /* Simple, readable styles */
    body { font-family: system-ui, Arial, sans-serif; margin: 2rem auto; max-width: 1100px; background-color: #fff5f8; }
    h1 { margin-bottom: .25rem; }
    .card { border: 1px solid #ddd; border-radius: 12px; padding: 1rem; margin: 1rem 0; background: #fff; }
    .row { display: flex; gap: .75rem; align-items: center; margin: .35rem 0; }
    .votes { font-weight: 600; background: rgba(0,0,0,.06); padding: .05rem .4rem; border-radius: 999px; }
    button { padding: .6rem 1rem; border-radius: 10px; border: 1px solid #333; cursor: pointer; }
    button:disabled { opacity: .6; cursor: not-allowed; }
    .success { color: #0a7a0a; }
    .error { color: #a10a0a; }
  </style>
  <style>
    button {
      background-color: #d1ff6e;
      border: none;
      color: #000;
      padding: 12px 20px;
      margin: 5px;
      font-size: 16px;
      cursor: pointer;
      border-radius: 8px;
      transition: background-color 0.3s ease;
    }
    button:hover {
      background-color: #b1ff08;
    }
    button:active {
      background-color: #6ea100;
    }
    .selected {
      border: 2px solid #FFD700;
      background-color: #3e8e41;
    }
    .bar {
      height: 20px;
      background-color: #4CAF50;
      text-align: right;
      padding-right: 5px;
      color: white;
      border-radius: 5px;
    }
    /* Highlight the selected member row */
    #members .selectable { border: 1px solid #ccc; border-radius: 8px; padding: .25rem .5rem; background: #fff; }
    #members .selectable.selected { border-color: #6ea100; background: #b1ff08; color: #000; }

    .layout { display: flex; gap: 1.25rem; align-items: flex-start; }
    .layout .card, .layout #results-section { flex: 1; }
    @media (max-width: 900px) { .layout { flex-direction: column; } }

    #results-section h2 { color: #6ea100; }

    .fact-img-wrap { margin-top: 1rem; }
    .fact-img { width: 100%; height: auto; border-radius: 10px; border: 1px solid #eee; display: block; }
  </style>

</head>
<body>
  <h1 style="text-align:center; font-family: Arial, sans-serif; color:#6ea100;">
    NCT 127 Bias Picker ðŸ’š
  </h1>
  <p id="status"></p>

  <div class="layout">
    <!-- VOTING CARD -->
    <div class="card" aria-labelledby="groupTitle">
      <div id="groupTitle" style="font-weight:600;"></div>
      <div id="members"></div>

      <div style="margin-top:1rem; display:flex; align-items:center; gap:.75rem;">
        <button id="voteBtn">Vote</button>
        <span id="voteMsg"></span>
      </div>
      <div class="fact-img-wrap">
        <img src="images/nct127-factcheck.jpg" alt="NCT 127 fact check" class="fact-img">
      </div>
    </div>
    
    <!-- RESULTS -->
    <section id="results-section" style="margin-top: 0rem;">
      <h2>Results</h2>
      <div id="results-bars"></div>
      <!-- <ul id="results" style="list-style: none; padding-left: 0;"></ul> -->
      <div id="results-total" style="margin-top: 0.5rem; font-weight: 600;"></div>
    </section>
  </div>

  <script>
    /******************************************************************
     * CONFIG â€” set these to your API Gateway base and your group id  *
     ******************************************************************/
    const API_BASE = "https://wbgdtiq28c.execute-api.us-east-1.amazonaws.com"; // your invoke URL
    const GROUP_ID = "nct127";

    const BASE = API_BASE.replace(/\/$/, ''); // normalize

    /******************************************************************
     * DOM elements                                                   *
     ******************************************************************/
    const statusEl       = document.getElementById('status');
    const titleEl        = document.getElementById('groupTitle');
    const membersEl      = document.getElementById('members');
    const voteBtn        = document.getElementById('voteBtn');
    const voteMsg        = document.getElementById('voteMsg');
    const resultsTotalEl = document.getElementById('results-total');

    /******************************************************************
     * State                                                          *
     ******************************************************************/
    let selectedMemberId = null;
    let lastMembersSnapshot = []; // [{ member, votes }]

    voteBtn.disabled = true; // until a member is selected

    /******************************************************************
     * Render members (radio list)                                    *
     ******************************************************************/
    function renderMembers(members) {
      membersEl.innerHTML = '';

      if (!Array.isArray(members) || members.length === 0) {
        membersEl.innerHTML = `<div style="opacity:.8">No members found for this group.</div>`;
        return;
      }

      members.forEach(m => {
        const row = document.createElement('div');
        row.className = 'row selectable'; // add 'selectable' so we can style it

        const input = document.createElement('input');
        input.type = 'radio';
        input.name = 'member';
        input.id = `m_${m.memberId}`;
        input.value = m.memberId;
        input.addEventListener('change', () => {
          selectedMemberId = m.memberId;
          voteBtn.disabled = false;

          document.querySelectorAll('#members .selectable.selected')
            .forEach(el => el.classList.remove('selected'));
          row.classList.add('selected');
        });

        const label = document.createElement('label');
        label.htmlFor = input.id;
        label.textContent = m.memberName;

        const votesSpan = document.createElement('span');
        votesSpan.className = 'votes';
        votesSpan.textContent = `(${Number(m.votes ?? 0)})`;

        row.appendChild(input);
        row.appendChild(label);
        row.appendChild(votesSpan);
        membersEl.appendChild(row);
      });
    }

    /******************************************************************
     * Fallback: build results from the group snapshot                *
     ******************************************************************/
    function buildResultsFromSnapshot() {
      const arr = lastMembersSnapshot.map(m => ({
        member: m.member,
        votes: Number(m.votes ?? 0)
      }));
      arr.sort((a, b) => b.votes - a.votes || a.member.localeCompare(b.member));
      const total = arr.reduce((sum, r) => sum + (Number.isFinite(r.votes) ? r.votes : 0), 0);
      return { results: arr, totalVotes: total };
    }

    /******************************************************************
     * GET /groups/{GROUP_ID}                                         *
     ******************************************************************/
    async function loadGroup() {
      statusEl.textContent = "Loading group...";
      try {
        const res  = await fetch(`${BASE}/groups/${encodeURIComponent(GROUP_ID)}`);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();

        titleEl.textContent = `${data.groupName}`;

        const members = Array.isArray(data.members) ? data.members : [];
        lastMembersSnapshot = members.map(m => ({
          member: m.memberName,
          votes: Number(m.votes ?? 0)
        }));

        renderMembers(members);
        statusEl.textContent = "";
      } catch (err) {
        console.error(err);
        statusEl.innerHTML = `<span class="error">Failed to load group. Check API_BASE/GROUP_ID & CORS.</span>`;
      }
    }

    /******************************************************************
     * GET /groups/{GROUP_ID}/results                                 *
     * Supports multiple shapes:
     *  1) { members: [{memberId, memberName, votes}, ...] }
     *  2) { results: [{member, votes}, ...] }
     *  3) { results: {memberId: votes, ...} }  (falls back to names from snapshot)
     ******************************************************************/
    async function fetchResults() {
      try {
        const res = await fetch(`${BASE}/groups/${encodeURIComponent(GROUP_ID)}/results`);
        let resultsData = null;

        if (res.ok) {
          const payload = await res.json();

          // Prefer the pretty members list if present
          if (Array.isArray(payload?.members) && payload.members.length > 0) {
            const rows = payload.members.map(m => ({
              member: String(m.memberName ?? m.memberId),
              votes: Number(m.votes ?? 0)
            }));
            rows.sort((a, b) => b.votes - a.votes || a.member.localeCompare(b.member));
            resultsData = { results: rows, totalVotes: rows.reduce((s, r) => s + r.votes, 0) };
          }
          // Or use results as an array of {member, votes}
          else if (Array.isArray(payload?.results) && payload.results.length > 0) {
            const rows = payload.results.map(r => ({
              member: String(r.member),
              votes: Number(r.votes ?? 0)
            }));
            rows.sort((a, b) => b.votes - a.votes || a.member.localeCompare(b.member));
            const total = Number(payload.totalVotes ?? rows.reduce((s, r) => s + r.votes, 0));
            resultsData = { results: rows, totalVotes: total };
          }
          // Or results as a map {id: votes}
          else if (payload && payload.results && typeof payload.results === 'object') {
            const map = payload.results;
            const rows = Object.keys(map).map(id => {
              // try to find a nice name from snapshot
              const snap = lastMembersSnapshot.find(m => m.member.toLowerCase().replace(/\s+/g,'') === id.toLowerCase());
              return {
                member: snap ? snap.member : id,
                votes: Number(map[id] ?? 0)
              };
            });
            rows.sort((a, b) => b.votes - a.votes || a.member.localeCompare(b.member));
            const total = rows.reduce((s, r) => s + r.votes, 0);
            resultsData = { results: rows, totalVotes: total };
          }
        }

        // Fallback if API returned nothing useful
        if (!resultsData) {
          resultsData = buildResultsFromSnapshot();
        }

        resultsTotalEl.textContent = `Total votes: ${resultsData.totalVotes}`;
        renderResultsBars(resultsData.results, resultsData.totalVotes);
      } catch (err) {
        console.error(err);
        const fallback = buildResultsFromSnapshot();
        resultsTotalEl.textContent = `Total votes: ${fallback.totalVotes}`;
      }
    }

    /******************************************************************
     * POST /groups/{GROUP_ID}/vote                                   *
     ******************************************************************/
    async function vote() {
      voteMsg.textContent = "";

      if (!selectedMemberId) {
        voteMsg.innerHTML = `<span class="error">Please select a member first.</span>`;
        return;
      }

      const oldText = voteBtn.textContent;
      voteBtn.textContent = "Submittingâ€¦";
      voteBtn.disabled = true;

      try {
        const res  = await fetch(`${BASE}/groups/${encodeURIComponent(GROUP_ID)}/vote`, {
          method: "POST",
          headers: {"Content-Type": "application/json"},
          body: JSON.stringify({ memberId: selectedMemberId })
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.message || `HTTP ${res.status}`);

        voteMsg.innerHTML = `<span class="success">Vote recorded for ${data.memberName || 'member'}!</span>`;

        // Refresh numbers
        await loadGroup();
        await fetchResults();
      } catch (err) {
        voteMsg.innerHTML = `<span class="error">${err.message}</span>`;
      } finally {
        voteBtn.textContent = oldText;
        selectedMemberId = null;
        const checked = document.querySelector('input[name="member"]:checked');
        if (checked) checked.checked = false;
        voteBtn.disabled = true;
        document.querySelectorAll('#members .selectable.selected')
        .forEach(el => el.classList.remove('selected'));
      }
    }

    function renderResultsBars(rows, total) {
      const el = document.getElementById('results-bars');
      if (!el) return;
      const t = Math.max(0, Number(total) || 0);

      el.innerHTML = rows.map(r => {
        const pct = t ? ((r.votes / t) * 100).toFixed(1) : '0.0';
        const label = parseFloat(pct) >= 6 ? pct + '%' : '';
        return `
          <p>${r.member}: ${r.votes} (${pct}%)</p>
          <div style="background:#ddd;border-radius:6px;overflow:hidden;margin:4px 0;">
            <div style="height:20px;width:${pct}%;background:#b1ff08;color:#000;
                        display:flex;align-items:center;justify-content:flex-end;
                        padding-right:6px;box-sizing:border-box;">
              ${label}
            </div>
          </div>`;
      }).join('');
    }

    /******************************************************************
     * Wire up + initial load                                         *
     ******************************************************************/
    document.getElementById('voteBtn').addEventListener('click', vote);
    loadGroup();
    fetchResults();
  </script>
</body>
</html>
